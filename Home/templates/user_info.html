{% extends 'base.html' %}
{% load static %}
{% block title %}My Account{% endblock %}

{% block main_content %}
<div class="flex flex-col-reverse sm:flex-row-reverse">
    <a href="{{ request.META.HTTP_REFERER }}" class="border-2 border-md cursor-pointer px-2 mr-4">
        Back
    </a>
</div>
<div class="grid grid-cols-2 justify-center items-center gap-4">
    <div class="flex flex-col">
        <div class="bg-white rounded-lg shadow overflow-hidden divide-y divide-gray-200 m-4">
            <!-- Name -->
            <div class="flex items-center justify-between px-6 py-2">
                <div>
                    <p class="text-sm font-semibold text-gray-600">Name</p>
                    <p class="text-lg text-gray-900">{{ current_user.name }}</p>
                </div>
                <a href="{% url 'edit_user_field' 'name' %}"
                   class="px-6 py-2 rounded-full border border-gray-300 text-sm hover:bg-gray-100">Edit</a>
            </div>

            <!-- Email -->
            <div class="flex items-center justify-between px-6 py-2">
                <div>
                    <p class="text-sm font-semibold text-gray-600">Email</p>
                    <p class="text-lg text-gray-900">{{ current_user.email }}</p>
                </div>
                <a href="{% url 'edit_user_field' 'email' %}"
                   class="px-6 py-2 rounded-full border border-gray-300 text-sm hover:bg-gray-100">Edit</a>
            </div>

            <!-- Phone -->
            <div class="flex items-center justify-between px-6 py-2">
                <div>
                    <p class="text-sm font-semibold text-gray-600">Primary mobile number</p>
                    <p class="text-lg text-gray-900">{{ current_user.phone }}</p>
                    <p class="text-xs text-gray-500">Quickly sign in, easily recover passwords and receive security
                        notifications with this number.</p>
                </div>
                <a href="{% url 'edit_user_field' 'phone' %}"
                   class="px-6 py-2 rounded-full border border-gray-300 text-sm hover:bg-gray-100">Edit</a>
            </div>
            <!-- Profile Image -->
        </div>


        {% if request.session.user_lat and request.session.user_lon %}
        <div class="mt-4 space-y-2">

            <div class="bg-gray-100 p-4 rounded shadow text-sm text-gray-700 space-y-1 m-6">
                {% if request.session.user_street %}
                <p><strong>Street:</strong> {{ request.session.user_street }}</p>
                {% endif %}
                {% if request.session.user_city %}
                <p><strong>City:</strong> {{ request.session.user_city }}</p>
                {% endif %}
                {% if request.session.user_postcode %}
                <p><strong>Pincode:</strong> {{ request.session.user_postcode }}</p>
                {% endif %}
                {% if request.session.user_lat %}
                <div class="mt-4 text-sm leading-relaxed text-gray-700">
                    <p><strong>Neighbourhood:</strong> {{ request.session.user_neighbourhood }}</p>
                    <p><strong>Suburb:</strong> {{ request.session.user_suburb }}</p>
                    <p><strong>City:</strong> {{ request.session.user_city }}</p>
                    <p><strong>District:</strong> {{ request.session.user_city_district }}</p>
                    <p><strong>County:</strong> {{ request.session.user_county }}</p>
                    <p><strong>State:</strong> {{ request.session.user_state }}</p>
                    <p><strong>State District:</strong> {{ request.session.user_state_district }}</p>
                    <p><strong>Country:</strong> {{ request.session.user_country }}</p>
                    <p><strong>Pincode:</strong> {{ request.session.user_postcode }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    <div class="flex flex-col">
        <div>
            <p class="text-sm font-semibold text-gray-600">Profile Image</p>
            {% if current_user.image %}
            <img src="{{ current_user.image.url }}" class="h-64 w-96 rounded mt-2 border" alt="User Image">
            {% else %}
            <p class="text-gray-500">No image uploaded.</p>
            {% endif %}
        </div>
        <div class="flex justify-center">
            <a href="{% url 'edit_user_field' 'image' %}"
               class="flex items-center border-2 rounded-md px-4 py-2">Edit</a>
        </div>
        <div class="mt-10">
            <a target="_blank"
               href="https://www.google.com/maps?q={{ request.session.user_lat }},{{ request.session.user_lon }}"
               class="text-blue-500 underline hover:text-blue-700 block ml-10">
                üìç View Current Location
            </a>
        </div>

    </div>
</div>
{% endblock main_content %}


{% block scripts %}
<script>
    navigator.geolocation.getCurrentPosition(
        function (position) {
            fetch('/save-location/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                })
            }).then(res => res.json()).then(data => {
                console.log("Location saved:", data);
            }).catch(err => {
                console.error("Error saving location:", err);
            });
        },
        function (error) {
            console.error("Error getting location:", error.message);
        },
        {
            enableHighAccuracy: true,  // Use GPS/Wi-Fi for best precision
            timeout: 10000,            // 10 seconds timeout
            maximumAge: 0              // Don't use cached position
        }
    );
</script>
{% endblock scripts %}


