{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block main_content %}
<div class="flex flex-col-reverse sm:flex-row-reverse mr-4 mt-2">
    <a href="{{ request.META.HTTP_REFERER }}" class="border-2 px-2">
        Back
    </a>
</div>
<div class="flex flex-col md:flex-row justify-center gap-10">
    <!-- Product Details -->
    <div class="flex flex-col justify-between">
        <div>
            <h1 class="text-[#c6922e] text-3xl font-bold mb-4">{{ product.name }}</h1>

            <!-- Quantity Selector -->
            <div class="flex items-center gap-3 mb-3">
                <button id="decrease" class="px-4 py-1 rounded border border-gray-400">-</button>
                <p id="qty" class="font-semibold border border-gray-400 px-4 py-1 rounded">1</p>
                <button id="increase" class="px-4 py-1 rounded border border-gray-400">+</button>
            </div>

            <!-- Display Amount -->
            <p class="text-lg text-gray-800">Amount: {{ bakery.country.currency_symbol }} <span id="display_total">{{ product.price }}</span>
            </p>
        </div>

        <!-- Order Now Form -->
        <form method="POST" action="{% url 'start_order' product.id %}" class="mt-6">
            {% csrf_token %}

            <!-- Weight Selection -->
            <label for="order_weight" class="block mb-1">Select Weight:</label>
            <select name="weight" id="order_weight" class="w-full border rounded p-2 mb-3">
                <option value="250gm">250 GM</option>
                <option value="500gm">500 GM</option>
                <option value="1kg" selected>1 KG</option>
                <option value="1500gm">1.5 KG</option>
                <option value="2kg">2 KG</option>
            </select>

            <!-- Hidden Inputs -->
            <input type="hidden" name="quantity" id="order_qty" value="1">
            <input type="hidden" name="total_amount" id="order_total_amount" value="{{ product.price }}">
            <button type="submit"
                    class="w-full bg-[#c6922e] text-white py-2 rounded hover:bg-[#b07d1e] transition">
                Order Now
            </button>
        </form>
    </div>

    <!-- Product Image & Actions -->
    <div class="flex flex-col gap-4">
        {% if product.image %}
        <img src="{{ product.image.url }}"
             alt="{{ product.name }}"
             class="h-96 w-64 object-cover rounded shadow-md relative">
        {% else %}
        <img src="{{ bakery.logo.url }}"
             alt="Default Logo"
             class="h-96 w-64 rounded shadow-md relative">
        {% endif %}

        <!-- Add to Cart -->
        <button class="cart-toggle bg-[#f8f4ee] text-[#c6922e] px-6 py-2 rounded-md flex items-center gap-2 justify-center"
                data-product-id="{{ product.id }}">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218
                       c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0
                       .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/>
            </svg>
            {% if product.id in cart_product_ids %}
            Added in Cart
            {% else %}
            Add to Cart
            {% endif %}
        </button>

        <!-- Wishlist -->
        <button class="wishlist-toggle absolute"
                data-product-id="{{ product.id }}">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="{% if product.id in wishlist_product_ids %}red{% else %}none{% endif %}"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="size-6"
                 data-state="{% if product.id in wishlist_product_ids %}added{% else %}not-added{% endif %}">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75
                   3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"/>
            </svg>
        </button>
    </div>
</div>
{% endblock main_content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.className = 'fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function handleAction(url, btn, type) {
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    showToast(data.message);
                    setTimeout(() => window.location.reload(), 800);
                })
                .catch(err => {
                    console.error(err);
                    showToast('Something went wrong');
                });
        }

        document.querySelectorAll('.wishlist-toggle').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const productId = btn.dataset.productId;
                const svg = btn.querySelector('svg');
                const state = svg.dataset.state;
                const url = state === 'added'
                    ? `/store/product/${productId}/remove_from_wishlist/`
                    : `/store/product/${productId}/add_to_wishlist/`;
                handleAction(url, btn, 'wishlist');
            });
        });

        document.querySelectorAll('.cart-toggle').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const productId = btn.dataset.productId;
                const url = `/store/add_to_cart/${productId}/`;
                handleAction(url, btn, 'cart');
            });
        });

        // DOM elements
        const increaseBtn = document.getElementById('increase');
        const decreaseBtn = document.getElementById('decrease');
        const qtyEl = document.getElementById('qty');
        const qtyInput = document.getElementById('order_qty');
        const weightSelect = document.getElementById('order_weight');
        const totalAmountInput = document.getElementById('order_total_amount');
        const displayTotal = document.getElementById('display_total');

        const unitPrice = {{ product.price|floatformat:2 }};
        let qty = 1;

        function getWeightMultiplier(weight) {
            switch (weight) {
                case '250gm': return 0.25;
                case '500gm': return 0.5;
                case '1kg': return 1;
                case '1500gm': return 1.5;
                case '2kg': return 2;
                default: return 1;
            }
        }

        function updateTotal() {
            const weight = weightSelect.value;
            const multiplier = getWeightMultiplier(weight);
            const total = unitPrice * multiplier * qty;

            totalAmountInput.value = total.toFixed(2);
            displayTotal.textContent = total.toFixed(2);
            qtyInput.value = qty;
            qtyEl.textContent = qty;
        }

        increaseBtn.addEventListener('click', () => {
            qty += 1;
            updateTotal();
        });

        decreaseBtn.addEventListener('click', () => {
            if (qty > 1) {
                qty -= 1;
                updateTotal();
            }
        });

        weightSelect.addEventListener('change', updateTotal);

        // Initial total setup
        updateTotal();
    });
</script>
{% endblock %}
